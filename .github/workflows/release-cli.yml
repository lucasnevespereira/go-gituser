name: release-cli

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g. 1.5.0)"
        required: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.3"

      - name: Validate GoReleaser config
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: check

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BREW_TOKEN: ${{ secrets.BREW_TOKEN }}

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -z "${{ github.event.inputs.version }}" ]]; then
              echo "Version input required when triggering manually."
              exit 1
            fi
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Homebrew formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating Homebrew formula for version $VERSION..."

          git clone https://github.com/lucasnevespereira/homebrew-tools.git
          cd homebrew-tools

          FORMULA_PATH="gituser.rb"
          if [ ! -f "$FORMULA_PATH" ]; then
            echo "Formula file not found!"
            exit 1
          fi

          sed -i.bak "s/^  version \".*\"/  version \"$VERSION\"/" $FORMULA_PATH

          for PLATFORM in darwin_all linux_arm64 linux_amd64; do
            FILE="gituser_${VERSION}_${PLATFORM}.tar.gz"
            URL="https://github.com/lucasnevespereira/go-gituser/releases/download/v${VERSION}/${FILE}"
            SHA256=$(curl -sL "$URL" | shasum -a 256 | awk '{print $1}')

            case "$PLATFORM" in
              darwin_all)
                sed -i.bak "s|url \".*darwin_all\.tar\.gz\"|url \"$URL\"|" $FORMULA_PATH
                sed -i.bak "s|sha256 \".*\"|sha256 \"$SHA256\"|" $FORMULA_PATH
                ;;
              linux_arm64)
                sed -i.bak "s|url \".*linux_arm64\.tar\.gz\"|url \"$URL\"|" $FORMULA_PATH
                sed -i.bak "s|sha256 \".*\"|sha256 \"$SHA256\"|" $FORMULA_PATH
                ;;
              linux_amd64)
                sed -i.bak "s|url \".*linux_amd64\.tar\.gz\"|url \"$URL\"|" $FORMULA_PATH
                sed -i.bak "s|sha256 \".*\"|sha256 \"$SHA256\"|" $FORMULA_PATH
                ;;
            esac
          done

          rm *.bak

          git config user.name "lucasnevespereira"
          git config user.email "pereiraneveslucas@gmail.com"
          git checkout -b bump-gituser-v${VERSION}
          git add "$FORMULA_PATH"
          git commit -m "chore(gituser): bump to v${VERSION}"
          git push origin bump-gituser-v${VERSION}

          gh pr create \
            --title "Update gituser to v${VERSION}" \
            --body "This PR updates the Homebrew formula for gituser to v${VERSION}." \
            --head bump-gituser-v${VERSION} \
            --base main

        env:
          GH_TOKEN: ${{ secrets.BREW_TOKEN }}
